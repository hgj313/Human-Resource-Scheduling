# Python后端开发学习计划 - 项目初始化阶段

## 学习目标

通过本阶段学习，您将掌握：
- 标准Python项目目录结构设计
- 虚拟环境创建和管理
- 依赖包管理和requirements.txt配置
- Git版本控制初始化和配置
- 项目基础配置文件编写

## 实战项目：人力资源调度系统后端

我们将以开发一个完整的人力资源调度系统为例，从零开始构建Python后端项目。

## 第一步：创建标准项目目录结构

### 1.1 项目目录规划

```
hr_scheduling_system/
├── app/                    # 应用核心代码
│   ├── __init__.py        # 应用初始化
│   ├── models/            # 数据模型
│   │   ├── __init__.py
│   │   ├── user.py        # 用户模型
│   │   ├── project.py     # 项目模型
│   │   └── schedule.py    # 调度模型
│   ├── api/               # API路由
│   │   ├── __init__.py
│   │   ├── auth.py        # 认证相关API
│   │   ├── users.py       # 用户管理API
│   │   ├── projects.py    # 项目管理API
│   │   └── schedules.py   # 调度管理API
│   ├── services/          # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── auth_service.py
│   │   ├── user_service.py
│   │   ├── project_service.py
│   │   └── schedule_service.py
│   ├── utils/             # 工具函数
│   │   ├── __init__.py
│   │   ├── validators.py  # 数据验证
│   │   ├── decorators.py  # 装饰器
│   │   └── helpers.py     # 辅助函数
│   └── schemas/           # 数据序列化
│       ├── __init__.py
│       ├── user_schema.py
│       ├── project_schema.py
│       └── schedule_schema.py
├── config/                # 配置文件
│   ├── __init__.py
│   ├── development.py     # 开发环境配置
│   ├── production.py      # 生产环境配置
│   └── testing.py         # 测试环境配置
├── tests/                 # 测试代码
│   ├── __init__.py
│   ├── conftest.py        # pytest配置
│   ├── test_auth.py       # 认证测试
│   ├── test_users.py      # 用户测试
│   ├── test_projects.py   # 项目测试
│   └── test_schedules.py  # 调度测试
├── migrations/            # 数据库迁移文件
├── docs/                  # 项目文档
│   ├── api.md            # API文档
│   └── deployment.md     # 部署文档
├── scripts/               # 脚本文件
│   ├── init_db.py        # 数据库初始化
│   └── seed_data.py      # 测试数据生成
├── requirements/          # 依赖文件
│   ├── base.txt          # 基础依赖
│   ├── development.txt   # 开发依赖
│   └── production.txt    # 生产依赖
├── .env.example          # 环境变量示例
├── .gitignore            # Git忽略文件
├── README.md             # 项目说明
├── run.py                # 应用启动文件
└── requirements.txt      # 主依赖文件
```

### 1.2 创建项目目录命令

```bash
# 创建主项目目录
mkdir hr_scheduling_system
cd hr_scheduling_system

# 创建应用核心目录
mkdir app
mkdir app/models app/api app/services app/utils app/schemas

# 创建配置和测试目录
mkdir config tests migrations docs scripts requirements

# 创建__init__.py文件
touch app/__init__.py
touch app/models/__init__.py
touch app/api/__init__.py
touch app/services/__init__.py
touch app/utils/__init__.py
touch app/schemas/__init__.py
touch config/__init__.py
touch tests/__init__.py
```

### 1.3 目录结构设计原则

**分层架构原则**：
- `models/`: 数据访问层，定义数据模型和数据库交互
- `api/`: 表现层，处理HTTP请求和响应
- `services/`: 业务逻辑层，实现核心业务功能
- `utils/`: 工具层，提供通用功能和辅助函数
- `schemas/`: 数据传输层，定义API输入输出格式

**关注点分离**：
- 配置文件独立管理（`config/`）
- 测试代码独立组织（`tests/`）
- 文档和脚本分别存放

## 第二步：创建和配置虚拟环境

### 2.1 使用venv创建虚拟环境

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/macOS
source venv/bin/activate

# 验证虚拟环境
which python  # 应该指向虚拟环境中的python
python --version
```

### 2.2 虚拟环境管理最佳实践

**环境变量配置**：
```bash
# 创建.env文件
touch .env

# .env文件内容示例
APP_MODULE=app.main:app
ENVIRONMENT=development
DATABASE_URL=postgresql://user:password@localhost/hr_scheduling
SECRET_KEY=your-secret-key-here
JWT_SECRET_KEY=your-jwt-secret-key
REDIS_URL=redis://localhost:6379/0
```

**虚拟环境脚本**：
```bash
# 创建activate脚本 (scripts/activate_env.sh)
#!/bin/bash
source venv/bin/activate
export $(cat .env | xargs)
echo "虚拟环境已激活，环境变量已加载"
```

### 2.3 Python版本管理

```bash
# 检查Python版本兼容性
python --version  # 推荐Python 3.8+

# 创建.python-version文件（pyenv用户）
echo "3.9.16" > .python-version

# 验证pip版本
pip --version
pip install --upgrade pip
```

## 第三步：依赖包管理和requirements.txt配置

### 3.1 基础依赖包安装

```bash
# 安装FastAPI框架和核心依赖
pip install fastapi==0.104.1
pip install uvicorn[standard]==0.24.0
pip install sqlalchemy==2.0.23
pip install alembic==1.12.1
pip install python-jose[cryptography]==3.3.0
pip install passlib[bcrypt]==1.7.4
pip install python-multipart==0.0.6

# 安装数据库驱动
pip install psycopg2-binary==2.9.7  # PostgreSQL
pip install PyMySQL==1.1.0          # MySQL

# 安装数据验证和序列化
pip install pydantic==2.5.0
pip install pydantic-settings==2.1.0

# 安装其他核心依赖
pip install python-dotenv==1.0.0    # 环境变量管理
pip install redis==4.6.0            # Redis客户端
pip install celery==5.3.1           # 异步任务队列
pip install gunicorn==21.2.0        # ASGI服务器
```

### 3.2 requirements.txt文件结构

**requirements/base.txt** (基础依赖):
```txt
# Web框架
fastapi==0.104.1
uvicorn[standard]==0.24.0

# 数据库
psycopg2-binary==2.9.7
sqlalchemy==2.0.23
alembic==1.12.1

# 数据验证和序列化
pydantic==2.5.0
pydantic-settings==2.1.0

# 认证和安全
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# 工具库
python-dotenv==1.0.0
redis==4.6.0
celery==5.3.1
requests==2.31.0

# 日期时间处理
python-dateutil==2.8.2

# 配置管理
click==8.1.7
**requirements/development.txt** (开发环境依赖):
```txt
-r base.txt

# 测试框架
pytest==7.4.2
pytest-cov==4.1.0
pytest-asyncio==0.21.1
httpx==0.25.2
factory-boy==3.3.0
```
# 代码质量
flake8==6.0.0
black==23.7.0
isort==5.12.0
mypy==1.5.1

# 开发工具
ipython==8.15.0
watchdog==3.0.0

# API文档（FastAPI自带Swagger UI）
# 无需额外依赖

# 调试工具
rich==13.5.2  # 美化输出
uvicorn[standard]==0.23.2  # 开发服务器
```

**requirements/production.txt** (生产环境依赖):
```txt
-r base.txt

# ASGI服务器
uvicorn[standard]==0.23.2
gunicorn==21.2.0  # 可选的进程管理器

# 监控和日志
prometheus-client==0.17.1
structlog==23.1.0

# 安全
fastapi-limiter==0.1.5  # API限流
secure==0.3.0  # 安全头设置
```

### 3.3 依赖管理最佳实践

**版本锁定策略**：
```bash
# 生成精确版本的requirements.txt
pip freeze > requirements.txt

# 安装指定版本依赖
pip install -r requirements/development.txt

# 更新依赖包
pip install --upgrade package_name
pip freeze > requirements.txt
```

**依赖安全检查**：
```bash
# 安装安全检查工具
pip install safety

# 检查依赖包安全漏洞
safety check

# 检查过期依赖
pip list --outdated
```

## 第四步：Git版本控制初始化

### 4.1 Git仓库初始化

```bash
# 初始化Git仓库
git init

# 配置用户信息
git config user.name "Your Name"
git config user.email "your.email@example.com"

# 设置默认分支
git config init.defaultBranch main
```

### 4.2 .gitignore文件配置

创建`.gitignore`文件：
```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
PYTHONPATH

# 虚拟环境
venv/
env/
ENV/
env.bak/
venv.bak/

# 环境变量
.env
.env.local
.env.development
.env.production

# 数据库
*.db
*.sqlite3

# 日志文件
*.log
logs/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# 操作系统
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# 测试覆盖率
.coverage
.pytest_cache/
cov.xml
*.cover
*.py,cover
.hypothesis/

# FastAPI
# 无特定忽略项，使用通用Python忽略规则

# Celery
celerybeat-schedule
celerybeat.pid

# Redis dump
dump.rdb

# 临时文件
*.tmp
*.temp

# 部署相关
.docker/
docker-compose.override.yml
```

### 4.3 Git工作流配置

**分支策略**：
```bash
# 创建开发分支
git checkout -b develop

# 创建功能分支
git checkout -b feature/user-authentication
git checkout -b feature/project-management
git checkout -b feature/scheduling-algorithm

# 创建发布分支
git checkout -b release/v1.0.0

# 创建热修复分支
git checkout -b hotfix/critical-bug-fix
```

**提交信息规范**：
```bash
# 提交类型
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建工具或辅助工具的变动

# 提交示例
git commit -m "feat(auth): 添加JWT用户认证功能"
git commit -m "fix(api): 修复用户列表分页问题"
git commit -m "docs(readme): 更新项目安装说明"
```

**Git Hooks配置**：
```bash
# 创建pre-commit hook
touch .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit

# pre-commit内容
#!/bin/bash
# 运行代码格式检查
black --check .
flake8 .

# 运行测试
pytest tests/ -v

if [ $? -ne 0 ]; then
    echo "提交失败：请修复代码质量问题"
    exit 1
fi
```

## 第五步：项目基础配置文件

### 5.1 应用配置文件

**config/__init__.py**:
```python
"""
配置模块初始化
"""
import os
from typing import Type

from .development import DevelopmentConfig
from .production import ProductionConfig
from .testing import TestingConfig

# 配置映射
config_map = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'testing': TestingConfig
}

def get_config() -> Type:
    """
    根据环境变量获取配置类
    
    Returns:
        配置类
    """
    env = os.getenv('ENVIRONMENT', 'development')
    return config_map.get(env, DevelopmentConfig)
```

**config/development.py**:
```python
"""
开发环境配置
"""
import os
from datetime import timedelta

class DevelopmentConfig:
    """
    开发环境配置类
    """
    # 基础配置
    DEBUG = True
    TESTING = False
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')
    
    # 数据库配置
    SQLALCHEMY_DATABASE_URI = os.getenv(
        'DATABASE_URL',
        'postgresql://postgres:password@localhost/hr_scheduling_dev'
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ECHO = True  # 开发环境显示SQL语句
    
    # JWT配置
    JWT_SECRET_KEY = os.getenv('JWT_SECRET_KEY', 'jwt-secret-change-in-production')
    JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=1)
    JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
    
    # Redis配置
    REDIS_URL = os.getenv('REDIS_URL', 'redis://localhost:6379/0')
    
    # Celery配置
    CELERY_BROKER_URL = os.getenv('CELERY_BROKER_URL', 'redis://localhost:6379/0')
    CELERY_RESULT_BACKEND = os.getenv('CELERY_RESULT_BACKEND', 'redis://localhost:6379/0')
    
    # 邮件配置
    MAIL_SERVER = os.getenv('MAIL_SERVER', 'localhost')
    MAIL_PORT = int(os.getenv('MAIL_PORT', 587))
    MAIL_USE_TLS = os.getenv('MAIL_USE_TLS', 'true').lower() in ['true', 'on', '1']
    MAIL_USERNAME = os.getenv('MAIL_USERNAME')
    MAIL_PASSWORD = os.getenv('MAIL_PASSWORD')
    
    # 日志配置
    LOG_LEVEL = 'DEBUG'
    LOG_FILE = 'logs/hr_scheduling_dev.log'
    
    # API限流配置
    RATELIMIT_STORAGE_URL = os.getenv('REDIS_URL', 'redis://localhost:6379/1')
    RATELIMIT_DEFAULT = "100 per hour"
    
    # 文件上传配置
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
    UPLOAD_FOLDER = 'uploads/'
    ALLOWED_EXTENSIONS = {'txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif', 'csv', 'xlsx'}
```

### 5.2 应用启动文件

**main.py**:
```python
#!/usr/bin/env python3
"""
人力资源调度系统 - FastAPI应用启动文件

使用方法:
    uvicorn main:app --reload
    python main.py
"""
import os
import uvicorn
from fastapi import FastAPI

from app import create_app
from app.core.config import settings

# 创建FastAPI应用实例
app = create_app()

if __name__ == '__main__':
    # 开发环境直接运行
    port = int(os.getenv('PORT', 8000))
    host = os.getenv('HOST', '127.0.0.1')
    
    uvicorn.run(
        "main:app",
        host=host,
        port=port,
        reload=settings.DEBUG,
        log_level="info" if not settings.DEBUG else "debug"
    )
```

**scripts/init_db.py** (数据库初始化脚本):
```python
#!/usr/bin/env python3
"""
数据库初始化脚本

使用方法:
    python scripts/init_db.py
"""
import asyncio
from sqlalchemy import create_engine
from sqlalchemy.ext.asyncio import create_async_engine

from app.core.config import settings
from app.models.base import Base
from app.models import User, Project, Schedule

async def init_db():
    """
    初始化数据库表
    """
    engine = create_async_engine(settings.DATABASE_URL)
    
    async with engine.begin() as conn:
        # 创建所有表
        await conn.run_sync(Base.metadata.create_all)
    
    print("数据库初始化完成")

async def seed_db():
    """
    填充测试数据
    """
    from scripts.seed_data import seed_database
    await seed_database()
    print("测试数据填充完成")

if __name__ == '__main__':
    asyncio.run(init_db())
```

### 5.3 README.md文档

**README.md**:
```markdown
# 人力资源调度系统后端

基于FastAPI的智能人力资源调度管理系统后端API服务。

## 功能特性

- 🔐 JWT用户认证和授权
- 👥 用户和角色管理
- 📋 项目管理
- 🤖 智能调度算法
- 📊 数据分析和报表
- 🔄 实时通知系统
- 📝 自动生成的API文档 (Swagger/OpenAPI)
- 🧪 全面的单元测试
- 🐳 Docker容器化部署

## 技术栈

- **Web框架**: FastAPI 0.104.1
- **ASGI服务器**: Uvicorn
- **数据库**: PostgreSQL + SQLAlchemy 2.0
- **数据迁移**: Alembic
- **认证**: JWT (python-jose)
- **数据验证**: Pydantic
- **缓存**: Redis
- **任务队列**: Celery
- **测试**: pytest + httpx
- **API文档**: 自动生成 (Swagger/OpenAPI)
- **部署**: Docker + Uvicorn/Gunicorn

## 快速开始

### 环境要求

- Python 3.8+
- PostgreSQL 12+
- Redis 6+

### 安装步骤

1. 克隆项目
```bash
git clone <repository-url>
cd hr_scheduling_system
```

2. 创建虚拟环境
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows
```

3. 安装依赖
```bash
pip install -r requirements/development.txt
```

4. 配置环境变量
```bash
cp .env.example .env
# 编辑.env文件，配置数据库连接等信息
```

5. 初始化数据库
```bash
alembic upgrade head
python scripts/init_db.py
```

6. 启动应用
```bash
uvicorn main:app --reload
# 或者
python run.py
```

### API文档

启动应用后访问: http://localhost:5000/api/docs

## 项目结构

```
hr_scheduling_system/
├── app/                 # 应用核心代码
├── config/             # 配置文件
├── tests/              # 测试代码
├── migrations/         # 数据库迁移
├── docs/               # 项目文档
├── scripts/            # 脚本文件
└── requirements/       # 依赖文件
```

## 开发指南

### 代码规范

项目遵循PEP8代码规范，使用以下工具进行代码质量控制：

```bash
# 代码格式化
black .

# 导入排序
isort .

# 代码检查
flake8 .

# 类型检查
mypy app/
```

### 测试

```bash
# 运行所有测试
pytest

# 运行测试并生成覆盖率报告
pytest --cov=app --cov-report=html

# 运行特定测试文件
pytest tests/test_auth.py -v
```

### 数据库迁移

```bash
# 生成迁移文件
alembic revision --autogenerate -m "描述信息"

# 应用迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

## 部署

### Docker部署

```bash
# 构建镜像
docker build -t hr-scheduling-api .

# 运行容器
docker run -p 5000:5000 hr-scheduling-api
```

### 生产环境部署

```bash
# 使用Gunicorn启动
gunicorn -w 4 -b 0.0.0.0:5000 "app:create_app()"
```

## 贡献指南

1. Fork项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建Pull Request

## 许可证

本项目采用MIT许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。
```

## 学习检查点

### PEP8代码规范要求

1. **命名规范**：
   - 模块名：小写字母，下划线分隔 (`user_service.py`)
   - 类名：驼峰命名 (`UserService`)
   - 函数名：小写字母，下划线分隔 (`get_user_by_id`)
   - 常量：大写字母，下划线分隔 (`MAX_RETRY_COUNT`)

2. **代码格式**：
   - 行长度不超过79字符
   - 使用4个空格缩进
   - 函数和类之间空2行
   - 导入语句按标准库、第三方库、本地库分组

3. **文档字符串**：
   - 所有公共函数和类必须有docstring
   - 使用Google风格或NumPy风格文档字符串

### 能力评估标准

**初级水平** (完成本阶段后应达到):
- [ ] 能够独立创建标准Python项目结构
- [ ] 熟练使用虚拟环境管理依赖
- [ ] 掌握requirements.txt的编写和管理
- [ ] 能够配置Git仓库和基本工作流
- [ ] 理解项目配置文件的作用和编写方法

**评估方式**:
1. 独立创建一个新的FastAPI项目，包含完整目录结构
2. 配置开发、测试、生产三套环境的依赖文件
3. 编写项目README文档
4. 设置Git仓库并完成首次提交

## 下一阶段预告

完成项目初始化后，我们将进入**基础开发阶段**，学习内容包括：
- FastAPI应用创建和配置
- 第一个RESTful API端点开发
- SQLAlchemy数据模型设计
- 数据库连接和基本CRUD操作

---

*继续学习下一阶段：[02-基础开发阶段学习计划](./02-基础开发阶段学习计划.md)*