# 数据库设计文档

## 文档概述

本文档详细描述了人力资源调度系统的数据库设计，包括数据库选型、表结构设计、索引优化和数据安全等内容。

## 1. 数据库选型

### 1.1 PostgreSQL优势
- **ACID事务支持**：确保数据一致性
- **JSON/JSONB支持**：灵活存储半结构化数据
- **全文检索**：内置全文搜索功能
- **扩展性**：丰富的扩展插件
- **性能优化**：查询优化器和索引支持

### 1.2 数据库配置
- **版本**：PostgreSQL 14+
- **字符集**：UTF-8
- **时区**：UTC
- **连接池**：PgBouncer
- **备份策略**：WAL归档 + 定期全量备份

## 2. 核心数据表设计

### 2.1 用户和权限表

#### 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    phone VARCHAR(20),
    avatar_url VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    is_superuser BOOLEAN DEFAULT false,
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 角色表 (roles)
```sql
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    permissions JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 用户角色关联表 (user_roles)
```sql
CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    assigned_by UUID REFERENCES users(id),
    UNIQUE(user_id, role_id)
);
```

### 2.2 组织架构表

#### 组织架构表 (organizations)
```sql
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE,
    type VARCHAR(20) NOT NULL, -- company, region, department, team
    parent_id UUID REFERENCES organizations(id),
    level INTEGER NOT NULL DEFAULT 1,
    path VARCHAR(500), -- 层级路径，如 /1/2/3/
    manager_id UUID REFERENCES users(id),
    description TEXT,
    contact_info JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 人员管理表

#### 人员档案表 (personnel)
```sql
CREATE TABLE personnel (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    employee_id VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    gender VARCHAR(10),
    birth_date DATE,
    id_card VARCHAR(20),
    phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    emergency_contact JSONB,
    organization_id UUID REFERENCES organizations(id),
    position VARCHAR(100),
    employment_type VARCHAR(20), -- full_time, part_time, contract
    hire_date DATE,
    skills JSONB, -- 技能信息
    certifications JSONB, -- 证书信息
    availability JSONB, -- 可用性信息
    status VARCHAR(20) DEFAULT 'active', -- active, inactive, on_leave
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 技能字典表 (skill_types)
```sql
CREATE TABLE skill_types (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    levels JSONB, -- 技能等级定义
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.4 项目管理表

#### 项目表 (projects)
```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    code VARCHAR(50) UNIQUE,
    description TEXT,
    client_id UUID,
    project_manager_id UUID REFERENCES personnel(id),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    location JSONB, -- 项目地点信息
    requirements JSONB, -- 人员需求信息
    budget DECIMAL(15,2),
    status VARCHAR(20) DEFAULT 'planning', -- planning, active, completed, cancelled
    priority VARCHAR(10) DEFAULT 'medium', -- low, medium, high, urgent
    tags JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 客户表 (clients)
```sql
CREATE TABLE clients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(200) NOT NULL,
    code VARCHAR(50) UNIQUE,
    contact_person VARCHAR(100),
    phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    company_info JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.5 调度管理表

#### 调度记录表 (schedules)
```sql
CREATE TABLE schedules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    personnel_id UUID REFERENCES personnel(id) NOT NULL,
    schedule_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    role VARCHAR(100),
    work_location JSONB,
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, completed
    notes TEXT,
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(personnel_id, schedule_date, start_time)
);
```

#### AI匹配结果表 (ai_matching_results)
```sql
CREATE TABLE ai_matching_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id UUID NOT NULL,
    project_id UUID REFERENCES projects(id),
    personnel_id UUID REFERENCES personnel(id),
    match_score DECIMAL(5,2), -- 匹配分数 0-100
    match_factors JSONB, -- 匹配因子详情
    recommendation_reason TEXT,
    algorithm_version VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.6 风险管控表

#### 风险识别记录表 (risk_identifications)
```sql
CREATE TABLE risk_identifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    risk_type VARCHAR(50) NOT NULL,
    risk_level VARCHAR(20) NOT NULL, -- low, medium, high, critical
    target_type VARCHAR(50), -- project, personnel, schedule
    target_id UUID,
    description TEXT,
    risk_factors JSONB,
    probability DECIMAL(5,2), -- 风险概率 0-100
    impact_score DECIMAL(5,2), -- 影响分数 0-100
    mitigation_suggestions JSONB,
    status VARCHAR(20) DEFAULT 'active', -- active, resolved, ignored
    detected_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 风险预警规则表 (risk_alert_rules)
```sql
CREATE TABLE risk_alert_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    risk_type VARCHAR(50) NOT NULL,
    conditions JSONB NOT NULL, -- 触发条件
    threshold_config JSONB, -- 阈值配置
    alert_level VARCHAR(20) NOT NULL, -- info, warning, error, critical
    notification_config JSONB, -- 通知配置
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.7 数据分析表

#### 配置评估结果表 (configuration_assessments)
```sql
CREATE TABLE configuration_assessments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    assessment_type VARCHAR(50) NOT NULL,
    target_id UUID,
    assessment_date DATE NOT NULL,
    metrics JSONB NOT NULL, -- 评估指标
    scores JSONB NOT NULL, -- 评估分数
    recommendations JSONB, -- 改进建议
    baseline_comparison JSONB, -- 基准对比
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 预测分析数据表 (predictive_analysis_data)
```sql
CREATE TABLE predictive_analysis_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    analysis_type VARCHAR(50) NOT NULL,
    prediction_target VARCHAR(100) NOT NULL,
    time_horizon VARCHAR(20), -- 预测时间范围
    input_data JSONB NOT NULL,
    prediction_results JSONB NOT NULL,
    confidence_level DECIMAL(5,2), -- 置信度
    model_version VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 索引设计

### 3.1 主要索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);

-- 人员表索引
CREATE INDEX idx_personnel_employee_id ON personnel(employee_id);
CREATE INDEX idx_personnel_organization_id ON personnel(organization_id);
CREATE INDEX idx_personnel_status ON personnel(status);
CREATE INDEX idx_personnel_skills ON personnel USING GIN(skills);

-- 项目表索引
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_start_date ON projects(start_date);
CREATE INDEX idx_projects_end_date ON projects(end_date);
CREATE INDEX idx_projects_client_id ON projects(client_id);

-- 调度表索引
CREATE INDEX idx_schedules_project_id ON schedules(project_id);
CREATE INDEX idx_schedules_personnel_id ON schedules(personnel_id);
CREATE INDEX idx_schedules_date ON schedules(schedule_date);
CREATE INDEX idx_schedules_status ON schedules(status);
CREATE INDEX idx_schedules_personnel_date ON schedules(personnel_id, schedule_date);

-- 风险表索引
CREATE INDEX idx_risk_identifications_type ON risk_identifications(risk_type);
CREATE INDEX idx_risk_identifications_level ON risk_identifications(risk_level);
CREATE INDEX idx_risk_identifications_target ON risk_identifications(target_type, target_id);
CREATE INDEX idx_risk_identifications_detected_at ON risk_identifications(detected_at);
```

### 3.2 复合索引
```sql
-- 调度查询优化
CREATE INDEX idx_schedules_project_date_status ON schedules(project_id, schedule_date, status);
CREATE INDEX idx_schedules_personnel_date_status ON schedules(personnel_id, schedule_date, status);

-- 风险监控优化
CREATE INDEX idx_risk_type_level_status ON risk_identifications(risk_type, risk_level, status);

-- AI匹配结果优化
CREATE INDEX idx_ai_matching_request_score ON ai_matching_results(request_id, match_score DESC);
```

## 4. 数据库优化

### 4.1 查询优化
- **使用EXPLAIN分析查询计划**
- **避免N+1查询问题**
- **使用JOIN代替子查询**
- **合理使用LIMIT和OFFSET**
- **利用CTE和窗口函数**

### 4.2 JSONB优化
```sql
-- 为JSONB字段创建GIN索引
CREATE INDEX idx_personnel_skills_gin ON personnel USING GIN(skills);
CREATE INDEX idx_projects_requirements_gin ON projects USING GIN(requirements);

-- JSONB查询示例
SELECT * FROM personnel 
WHERE skills @> '[{"skill_type": "园林设计", "skill_level": "高级"}]';
```

### 4.3 分区表设计
```sql
-- 按时间分区的调度历史表
CREATE TABLE schedule_history (
    id UUID,
    project_id UUID,
    personnel_id UUID,
    schedule_date DATE,
    -- 其他字段...
    created_at TIMESTAMP WITH TIME ZONE
) PARTITION BY RANGE (schedule_date);

-- 创建分区
CREATE TABLE schedule_history_2024_q1 PARTITION OF schedule_history
FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');
```

## 5. 数据安全

### 5.1 数据加密
- **传输加密**：HTTPS/TLS 1.3
- **存储加密**：数据库字段级加密
- **密码加密**：bcrypt + salt
- **敏感数据**：AES-256加密存储

### 5.2 数据脱敏
```python
# 敏感数据脱敏示例
def mask_phone(phone: str) -> str:
    """手机号脱敏"""
    if len(phone) >= 11:
        return phone[:3] + '****' + phone[-4:]
    return phone

def mask_id_card(id_card: str) -> str:
    """身份证号脱敏"""
    if len(id_card) >= 18:
        return id_card[:6] + '********' + id_card[-4:]
    return id_card
```

### 5.3 数据备份安全
- **备份加密**：备份文件AES加密
- **访问控制**：备份文件访问权限控制
- **异地备份**：多地域备份存储
- **备份验证**：定期验证备份完整性

## 6. 数据迁移

### 6.1 迁移脚本
```python
# Alembic迁移示例
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # 创建新表
    op.create_table('personnel',
        sa.Column('id', postgresql.UUID(), nullable=False),
        sa.Column('employee_id', sa.VARCHAR(50), nullable=False),
        sa.Column('name', sa.VARCHAR(100), nullable=False),
        # 其他字段...
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('employee_id')
    )
    
    # 创建索引
    op.create_index('idx_personnel_employee_id', 'personnel', ['employee_id'])

def downgrade():
    op.drop_table('personnel')
```

### 6.2 数据导入
```python
# 批量数据导入
import pandas as pd
from sqlalchemy import create_engine

def import_personnel_data(csv_file: str):
    """导入人员数据"""
    engine = create_engine(DATABASE_URL)
    
    # 读取CSV文件
    df = pd.read_csv(csv_file)
    
    # 数据清洗和验证
    df = clean_personnel_data(df)
    
    # 批量插入
    df.to_sql('personnel', engine, if_exists='append', index=False)
```

## 7. 监控和维护

### 7.1 性能监控
```sql
-- 慢查询监控
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- 索引使用情况
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 7.2 数据库维护
```sql
-- 定期VACUUM和ANALYZE
VACUUM ANALYZE personnel;
VACUUM ANALYZE projects;
VACUUM ANALYZE schedules;

-- 重建索引
REINDEX INDEX idx_schedules_personnel_date;

-- 更新统计信息
ANALYZE;
```

---

本文档详细描述了人力资源调度系统的数据库设计方案，为系统的数据存储、查询优化和安全保障提供了完整的技术规范。